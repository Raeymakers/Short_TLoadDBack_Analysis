---
title: "PVT_VAS-f_analysis"
author: "Sofie Raeymakers"
date: "5/3/2022"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls()) # Clear environment
cat("\014") # Clear console
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning = FALSE}
##### Set environment #####

library(tidyverse)

# Get and declare functions
#Set working directory to the folder in which all CSV files are located

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
source("C:/Users/ASUSTeK/OneDrive/Documenten/Github/Short_TLoadDBack/functions.R") # This is a file in the same directory where you can stash your functions so you can save them there and have them together

Dir = "C:/Users/ASUSTeK/OneDrive/Documenten/Github/Short_TLoadDBack/Data/"
setwd(Dir)

#Download PVT data (this datafile is made in 'preprocessing')
PVT <- read.csv(paste0(Dir, "PVT.csv"), header = TRUE, sep = )

#Download VAS-f data
VAS <- read.csv(paste0(Dir, "VAS.csv"), header = TRUE, sep = )
#VAS has 'quantised: 1-11 instead of 0-10

#Download EXP data
EXP <- read.csv(paste0(Dir, "EXP.csv"), header = TRUE, sep = )

```

```{r}
### CHECKING TLOADNBACK#

# count 'accuracy' (0 or 1) in LCL vs HCL
sum(EXP$accuracy[EXP$Condition=="HCL"])
sum(EXP$accuracy[EXP$Condition=="LCL"])
mean(EXP$accuracy[EXP$Condition=="HCL"])
mean(EXP$accuracy[EXP$Condition=="LCL"])

EXP$Day <- factor(EXP$Day)
EXP$Condition <- factor(EXP$Condition)

#do this with shihny!!
three_way_acc <-lm(accuracy~Condition * Day, data=EXP)
one_way_acc <- lm(accuracy~Condition , data=EXP)
summary(three_way_acc)
summary(one_way_acc)
library(effects)
plot(one_way_acc)

three_way_prop <- lm(prop_correct~Condition * Day, data=EXP)
one_way_prop <- lm(prop_correct~Condition, data=EXP)
summary(three_way_prop)
summary(one_way_prop)


#visualise
library(emmeans)
emmeans1 <- emmeans(fit, pairwise ~ Condition | Day, adjust ="fdr", type = "response")
two_way_emm <- summary(emmeans1)$emmeans

emmeans2 <- emmeans(fit, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans

  
plot <- one_way_plotf(EXP, one_way_emm, "prop_correct")

plot <- two_way_plotf(EXP, two_way_emm, "prop_correct")


```

```{r}
#### CLEANING PVT ####

#Dataframe from day 1
PVT1 <- PVT[!(PVT$Day==2),]

library(reshape2)
library(cowplot)

#plot reaction times with raincloudplot
d<-melt(data.frame(rt=c(PVT1$RT))) # we melt to wide format 
ggplot(d, aes(x = variable, y = value, fill=variable))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  ylab('rt')+xlab('amount')+coord_flip()+theme_cowplot()+
  geom_point(position=position_jitter(width=.15), size=2)+
  geom_boxplot(width= .10, outlier.shape = NA)+
  theme(legend.position="none")+
  ggtitle("reaction times with outliers")

summary(PVT1$RT)
hist(PVT1$RT,
     xlab = "RT",
     main = "Histogram of RT",
     breaks = sqrt(nrow(PVT1)))

print('upper 97.5% bound')
quantile (PVT1$RT, 0.975)


# remove RT over 2000 millisec
PVT1 <- subset(PVT1, RT < 3800)
d<-melt(data.frame(rt=c(PVT1$RT)))
ggplot(d, aes(x = variable, y = value, fill=variable))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  geom_point(position=position_jitter(width=.15), size=0.25)+
  ylab('rt')+xlab('amount')+coord_flip()+theme_cowplot()+
  geom_boxplot(width= .10, outlier.shape = NA)+
  theme(legend.position="none")+
  guides(fill=FALSE)+
  ggtitle("reaction times < 3800 millisec")

summary(PVT1$RT)
hist(PVT1$RT,
     xlab = "RT",
     main = "Histogram of RT",
     breaks = sqrt(nrow(PVT1)))


out<-boxplot.stats(PVT1$RT)$out#outliers
out_ind<-which(PVT1$RT %in% c(out))#row numbers that contain outliers
boxplot(PVT1$RT, ylab='rt') #boxplot
mtext(paste('boxplot with outliers')) #boxplot with outliers

#remove outliers: sign that they were not paying attention
outliers <- boxplot(PVT1$RT, plot=FALSE)$out
PVT1<- PVT1[-which(PVT1$RT %in% outliers),]

# check normality of PVT1 RT
library("car")
qqPlot(PVT1$RT)

# log transform data
PVT1$RT = log(PVT1$RT)

qqPlot(PVT1$RT)


################ PVT ################

#plot reaction times with raincloudplot
library(reshape2)
library(cowplot)
d<-melt(data.frame(RT=c(PVT$RT))) # we melt to wide format 
ggplot(d, aes(x = variable, y = value, fill=variable))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  coord_flip()+
  theme_cowplot()+
  geom_point(position=position_jitter(width=.15), size=2)+
  geom_boxplot(width= .10, outlier.shape = NA)+
  theme(legend.position="none")


### Do like Borrogan : mean 1/RT

PVT$RT <- 1/(PVT$RT/1000) #1/RT

d<-melt(data.frame(RT=c(PVT$RT))) # we melt to wide format 
ggplot(d, aes(x = variable, y = value, fill=variable))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  coord_flip()+
  theme_cowplot()+
  geom_point(position=position_jitter(width=.15), size=2)+
  geom_boxplot(width= .10, outlier.shape = NA)+
  theme(legend.position="none")

# we have 97 iDs. Each participant is in either LCL or HCL
for (i in 1:97) {
  PVT$MeanRT[PVT$ID==i & PVT$Test==1 & PVT$Day==1]= mean (PVT$RT[PVT$ID==i & PVT$Test==1 & PVT$Day==1])
  PVT$MeanRT[PVT$ID==i & PVT$Test==2 & PVT$Day==1]= mean (PVT$RT[PVT$ID==i & PVT$Test==2 & PVT$Day==1])
  PVT$MeanRT[PVT$ID==i & PVT$Test==1 & PVT$Day==2]= mean (PVT$RT[PVT$ID==i & PVT$Test==1 & PVT$Day==2])
  PVT$MeanRT[PVT$ID==i & PVT$Test==2 & PVT$Day==2]= mean (PVT$RT[PVT$ID==i & PVT$Test==2 & PVT$Day==2])
  }

# remove duplicates: now only 1 datapoint per MeanRT
PVT_c <- PVT[!duplicated(PVT$MeanRT), ]

length(unique(PVT_c$MeanRT))
#388
97*4

glimpse(PVT_clean)





#plot reaction times with raincloudplot
d<-melt(data.frame(rt=c(PVT_c$MeanRT))) # we melt to wide format 
ggplot(d, aes(x = variable, y = value, fill=variable))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  ylab('MeanRT')+xlab('amount')+coord_flip()+theme_cowplot()+
  geom_point(position=position_jitter(width=.15), size=2)+
  geom_boxplot(width= .10, outlier.shape = NA)+
  theme(legend.position="none")+
  ggtitle("reciprocal reaction times")

summary(PVT_c$MeanRT)
hist(PVT_c$MeanRT,
     xlab = "MeanRT",
     main = "Histogram of MeanRT",
     breaks = sqrt(nrow(PVT)))

qqPlot(PVT_c$MeanRT)


```

```{r}

# make factors
PVT_c$Day <- factor(PVT_c$Day)
PVT_c$Test <- factor(PVT_c$Test)
PVT_c$Condition <- factor(PVT_c$Condition)

levels(PVT_c$Condition)

# formula <- lm( PVT_c$MeanRT ~ PVT_c$Condition * PVT_c$Day * PVT_c$Test + 1|PVT_c$ID)

# summarize data per group
library(dplyr)
sum <- group_by(PVT_c, Condition, Test, Day) %>%
  summarise(
    count = n(),
    mean = mean(MeanRT, na.rm = TRUE),
    sd = sd(RT, na.rm = TRUE)
  )
sum 



library(ggplot2)
ggplot(sum, aes(x=Condition, y=mean)) + 
  geom_violin()
ggplot(PVT_c, aes(x=Condition, y=MeanRT)) + 
  geom_violin()

library("ggpubr")
ggboxplot(PVT_c, x = "Condition", y = "MeanRT", 
          color = "Condition", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          ylab = "RT", xlab = "Condition")



# one_way <- lm(Diff~Condition , data=VASC)
# emmeans1 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
# one_way_emm <- summary(emmeans2)$emmeans
# one_way_plotf(VASC, one_way_emm, "Diff")
# 
# Anova(one_way, type='III')
# summary(emmeans1)
# emmeans1$contrasts
# 
# two_way <-lm(Diff~Condition * Day, data=VASC)
# emmeans2 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
# one_way_emm <- summary(emmeans2)$emmeans
# two_way_plotf(VASC, two_way_emm, "MeanR")
# 
# Anova(two_way, type='III')
# summary(emmeans2)
# emmeans2$contrasts


```

```{r}

########## VAS-f ###########

# take means
#each time 13 questions, with answers on a scale of 0-9 (Response)
# if Question.key ocntains 'quantised' then it is on 1-10 (filter out!)
VAS <-VAS[(grepl("quantised", VAS$Question.Key)),]



# take mean of the scale per participant, per day/test. 
for (i in 1:97) {
  VAS$MeanR[VAS$ID==i & VAS$Test==1 & VAS$Day==1]= mean (VAS$Response[VAS$ID==i & VAS$Test==1 & VAS$Day==1])
  VAS$MeanR[VAS$ID==i & VAS$Test==2 & VAS$Day==1]= mean (VAS$Response[VAS$ID==i & VAS$Test==2 & VAS$Day==1])
  VAS$MeanR[VAS$ID==i & VAS$Test==1 & VAS$Day==2]= mean (VAS$Response[VAS$ID==i & VAS$Test==1 & VAS$Day==2])
  VAS$MeanR[VAS$ID==i & VAS$Test==2 & VAS$Day==2]= mean (VAS$Response[VAS$ID==i & VAS$Test==2 & VAS$Day==2])
}

# check if conditions are equal
length(VAS$MeanR[VAS$Test==1 & VAS$Day ==1 & VAS$ID==1])
length(VAS$MeanR[VAS$Test==2 & VAS$Day ==1 & VAS$ID==1])
length(VAS$MeanR[VAS$Test==1 & VAS$Day ==2 & VAS$ID==1])
length(VAS$MeanR[VAS$Test==2 & VAS$Day ==2 & VAS$ID==1])

#make dataframe with 1 measure per condition
VASC<- VAS[VAS$Question.Key=='0-quantised',]

length(VASC$MeanR[VASC$Test==1 & VASC$Day ==1 & VASC$ID==1])
length(VASC$MeanR[VASC$Test==2 & VASC$Day ==1 & VASC$ID==1])
length(VASC$MeanR[VASC$Test==1 & VASC$Day ==2 & VASC$ID==1])
length(VASC$MeanR[VASC$Test==2 & VASC$Day ==2 & VASC$ID==1])


VASC = subset(VASC, select = -c(Question.Key, Response  ))

 # make factors
VAS$Day <- factor(VAS$Day)
VASC$Test <- factor(VASC$Test)
VASC$Condition <- factor(VASC$Condition)

#count
sum(VASC$MeanR[VASC$Condition=="HCL"])
sum(VASC$MeanR[VASC$Condition=="LCL"])
mean(VASC$MeanR[VASC$Condition=="HCL"])
mean(VASC$MeanR[VASC$Condition=="LCL"])


#visualise
library(emmeans)
emmeans1 <- emmeans(three_way, pairwise ~ Condition | Day, adjust ="fdr", type = "response")
two_way_emm <- summary(emmeans1)$emmeans

emmeans2 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans

one_way_plotf(VASC, one_way_emm, "MeanR")

two_way_plotf(VASC, two_way_emm, "MeanR")


# correcting for baseline: VASC$Diff as VAs op test 2 - test 1 per dag
# option 1: op de meanR van VASC

for (i in 1:97) {
  VASC$Diff[VASC$ID==i & VASC$Day==1] = (VASC$MeanR[VASC$Test==2 & VASC$ID==i & VASC$Day==1]- VASC$MeanR[VASC$Test==1 & VASC$ID==i & VASC$Day==1])
  VASC$Diff[VASC$ID==i & VASC$Day==2] = (VASC$MeanR[VASC$Test==2 & VASC$ID==i & VASC$Day==2]- VASC$MeanR[VASC$Test==1 & VASC$ID==i & VASC$Day==2])
}

# now we can visualise & do analysis on this difference score 
#count
sum(VASC$Diff[VASC$Condition=="HCL"])
sum(VASC$Diff[VASC$Condition=="LCL"])
mean(VASC$Diff[VASC$Condition=="HCL"])
mean(VASC$Diff[VASC$Condition=="LCL"])

one_way <- lm(Diff~Condition , data=VASC)
emmeans1 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans
one_way_plotf(VASC, one_way_emm, "Diff")

Anova(one_way, type='III')
summary(emmeans1)
emmeans1$contrasts

two_way <-lm(Diff~Condition * Day, data=VASC)
emmeans2 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans
two_way_plotf(VASC, two_way_emm, "MeanR")

Anova(two_way, type='III')
summary(emmeans2)
emmeans2$contrasts

#option 2: baseline correction directly on response scores
for (i in 1:97) {
  VAS$Diff[VAS$ID==i & VAS$Day==1] = (VAS$MeanR[VAS$Test==2 & VAS$ID==i & VAS$Day==1]- VAS$MeanR[VAS$Test==1 & VAS$ID==i & VAS$Day==1])
  VAS$Diff[VAS$ID==i & VAS$Day==2] = (VAS$MeanR[VAS$Test==2 & VAS$ID==i & VAS$Day==2]- VAS$MeanR[VAS$Test==1 & VAS$ID==i & VAS$Day==2])
}

sum(VAS$Diff[VAS$Condition=="HCL"])
sum(VAS$Diff[VAS$Condition=="LCL"])
mean(VAS$Diff[VAS$Condition=="HCL"])
mean(VAS$Diff[VAS$Condition=="LCL"])


one_way <- lm(Diff~Condition , data=VAS)
emmeans1 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans
one_way_plotf(VAS, one_way_emm, "Diff") 

Anova(one_way, type='III')
summary(emmeans1)
emmeans1$contrasts


library("ggplot2")
emmeans1<-data.frame(emmeans1)
emmeans1<-emmeans1[-c(3),]
ggplot(emmeans1, aes(Condition, emmean)) +        # ggplot2 plot with confidence intervals
  geom_point() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL))



two_way <-lm(Diff~Condition * Day, data=VAS)
emmeans2 <- emmeans(one_way, pairwise ~ Condition, adjust ="fdr", type = "response")
one_way_emm <- summary(emmeans2)$emmeans
two_way_plotf(VAS, two_way_emm, "MeanR")

Anova(two_way, type='III')
summary(emmeans2)
emmeans2$contrasts





# option 3: baseline correction, then means of that






```